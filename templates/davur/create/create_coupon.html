{% extends 'davur/elements/base_modal.html' %}

{% block modal_title_block %}
    <h5 class="modal-title">Añadiendo cupón</h5>
{% endblock modal_title_block %}

{% block form_block %}
<form id="coupon-form" method="POST" action="{% url 'ors:create_coupon'%}">
    <div class="modal-body">
        <div class="basic-form">

            {% csrf_token %}

            <label class ="form-label" for="name">Código</label>
            {{ form.code }}

            <br>
            <label class ="form-label" for="price_per_pizza">Descuento</label>
            {{ form.discount }}

            <br>
            <label class="form-label" for="available">Estado</label>"
            {{ form.status }}

            <div class="modal-footer">

                <div id="error-message" class="align-content-center"></div>

                <button type="button" class="btn btn-danger light" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" class="btn btn-primary">Añadir</button>
            </div>
        </div>
    </div>
</form>
{% endblock form_block %}

{% block additionalAjax %}

    <script>
        $(document).ready(function() {
      $('#coupon-form').submit(function(event) {
        event.preventDefault(); // Prevent the default form submission

        var form = $(this);
        var formData = form.serialize(); // Serialize the form data

        // Send the AJAX request to check coupon code availability
        $.ajax({
          url: form.attr('action'),
          type: form.attr('method'),
          data: formData,
          success: function(response) {
            // Check if coupon code is available
            if (response.exists) {
              // Show an error message in the modal
              $('#error-message').text('El código de cupón ya existe');
            } else {
              // Submit the form if coupon code is valid
              window.location.href = 'coupons';
            }
          },
          error: function(xhr, status, error) {
            // Handle error if the AJAX request fails
            console.error(xhr.responseText);
          }
        });
      });
    });




    </script>


{% endblock additionalAjax %}
